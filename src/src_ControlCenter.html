<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>ãƒ‰ãƒ©ãƒ•ãƒˆé‹å–¶ã‚»ãƒ³ã‚¿ãƒ¼</title>
  <style>
    :root{
      --border:#ddd; --muted:#777; --bg:#fff; --btn:#f8f8f8; --accent:#e74c3c; --ok:#0a7;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; padding:14px; background:#fafafa; margin:0;}
    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    @media screen {
      body { max-width:100%; overflow-x:hidden; }
    }
    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸‹å¯„ã›ã«ã™ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
    html, body { min-height: 100vh; }
    body { display: flex; flex-direction: column; }
    body > *:last-child { margin-top: auto; }
    h2{margin:8px 0 12px}
    h3{margin:2px 0 10px}
    .tabs{display:flex; gap:6px; margin-bottom:10px;}
    .tab{padding:8px 12px; border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:#eee; cursor:pointer}
    .tab.active{background:#fff; font-weight:700}
    .panel{border:1px solid var(--border); border-radius:0 8px 8px 8px; padding:12px; background:var(--bg);}
    .card{border:1px solid var(--border); border-radius:12px; padding:12px; margin:10px 0; background:#fff;}
    .row{display:flex; gap:8px; align-items:center; margin:6px 0; flex-wrap:wrap}
    .btn{padding:8px 12px; border-radius:8px; border:1px solid #999; background:var(--btn); cursor:pointer}
    .btn.disabled{opacity:.5; pointer-events:none}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .pill{padding:2px 8px; border-radius:999px; background:#eee; margin-left:6px;}
    input[type="text"],input[type="number"]{padding:6px 8px; border:1px solid #ccc; border-radius:6px; width:100%;}
    .muted{color:var(--muted); font-size:12px}
    .kvs{display:grid; grid-template-columns:auto 1fr; gap:6px 10px; align-items:center}
    .kvs div{padding:2px 0}

    /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆæŠ½é¸ã‚¿ãƒ–ï¼‰ */
    .roulette-wrap{position:relative; overflow:hidden; border:2px solid #333; border-radius:12px; height:64px; background:#fafafa}
    .roulette-strip{display:flex; align-items:center; height:64px; will-change: transform;}
    .chip{min-width:120px; height:64px; display:grid; place-items:center; border-right:1px solid #e1e1e1; font-weight:700;}
    .chip:last-child{border-right:none}
    .pointer{position:absolute; left:50%; top:0; transform:translateX(-50%); height:100%; width:2px; background:var(--accent);}
    .winner{font-weight:800; color:var(--ok);}
  </style>
</head>
<body>
  <h2>ãƒ‰ãƒ©ãƒ•ãƒˆé‹å–¶ã‚»ãƒ³ã‚¿ãƒ¼</h2>
  <div class="row" style="justify-content:space-between; margin:-6px 0 6px;">
    <div id="connLight" class="muted">æ¥ç¶š: ç¢ºèªä¸­â€¦</div>
    <button class="btn" onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div class="tabs">
    <div class="tab active" data-tab="admin">é‹å–¶</div>
    <div class="tab" data-tab="draw">æŠ½é¸</div>
  </div>

  <!-- ãƒ‘ãƒãƒ«ï¼šé‹å–¶ -->
  <div class="panel" id="panel-admin">
    <div class="card" id="status">
      <div>Round/Sub: â€“ / â€“</div>
      <div class="muted">æ›´æ–°ä¸­â€¦</div>
    </div>

    <div class="card">
      <h3>ã‚ˆãä½¿ã†æ“ä½œ</h3>
      <div class="row">
        <button class="btn" id="open">å—ä»˜é–‹å§‹</button>
        <button class="btn" id="close">å—ä»˜åœæ­¢</button>
        <button class="btn" id="resolve">æ‰‹å‹•è§£æ±º</button>
      </div>
    </div>

    <div class="card">
      <h3>è¨­å®š</h3>
      <div class="row">
        <label><input type="checkbox" id="manual"> æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ï¼ˆæŠ½é¸ã¯UIã§é€²è¡Œï¼‰</label>
      </div>
      <div class="row">
        <div style="flex:1">
          <div class="muted">Eligible Captainsï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</div>
          <input type="text" id="eligibleCsv" placeholder="ä¾‹: A,B,C">
        </div>
        <button class="btn" id="setEligible">æ›´æ–°</button>
      </div>
      <div class="row">
        <div style="width:90px"><div class="muted">Round</div><input type="number" id="round" min="1"></div>
        <div style="width:90px"><div class="muted">Sub</div><input type="number" id="sub" min="1"></div>
        <button class="btn" id="setRS">è¨­å®š</button>
      </div>
    </div>

    <div class="card">
      <h3>ãƒªãƒ³ã‚¯</h3>
      <div class="row">
        <button id="formLink" class="btn" onclick="copyToClipboard('formLink')">ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã</button>
        <button id="editLink" class="btn" onclick="copyToClipboard('editLink')">ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†</button>
      </div>
    </div>

    <div class="card">
      <details style="cursor:pointer;">
        <summary style="font-weight:bold; padding:4px 0; user-select:none;">è©³ç´°è¨­å®šï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
        <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
          <div class="row">
            <button class="btn" id="rebuild">ãƒˆãƒªã‚¬ãƒ¼å†ä½œæˆ</button>
          </div>
          <div class="row">
            <button class="btn" id="sync">é¸æŠè‚¢åŒæœŸ</button>
          </div>
          <div class="row">
            <button class="btn" id="compact">å›ç­”ã‚¿ãƒ–åœ§ç¸®</button>
            <button class="btn" id="reset">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn" onclick="setBusy(false)" style="opacity:0.7;">âš  å¼·åˆ¶è§£é™¤</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="importCaptains">Captainsã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="btn" id="importPlayers">Playersã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </div>
        </div>
      </details>
    </div>
  </div>

  <!-- ãƒ‘ãƒãƒ«ï¼šæŠ½é¸ -->
  <div class="panel" id="panel-draw" style="display:none">
    <div id="summary" class="card">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div id="singles" class="card" style="display:none">
      <h3>å˜ç‹¬æŒ‡å</h3>
      <div id="singlesList"></div>
      <button class="btn" id="commitSinglesBtn">å˜ç‹¬ã‚’ã¾ã¨ã‚ã¦ç¢ºå®š</button>
    </div>

    <div id="contests" class="card" style="display:none">
      <h3>ç«¶åˆã®æŠ½é¸ <span class="muted">ï¼ˆå„ªå…ˆPtæœ€å¤§ãŒè‡ªå‹•å‹åˆ©ï¼åŒç‡ã®ã¿æŠ½é¸ï¼‰</span></h3>
      <div id="contestList"></div>
    </div>

    <div class="row">
      <button class="btn" id="advanceBtn">æ¬¡ã¸é€²ã‚ã‚‹</button>
    </div>
  </div>

  <script>
    // ===== å…±é€š =====
    const el = id => document.getElementById(id);
    let busy=false;
    let dataUpdateCheckInterval = null; // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ç”¨
    let lastKnownTimestamp = ''; // æœ€å¾Œã«ç¢ºèªã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    function copyToClipboard(buttonId) {
      const btn = el(buttonId);
      const url = btn.dataset.url;
      if (!url || url === '#') {
        alert('ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‰ãƒ©ãƒ•ãƒˆæº–å‚™ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      navigator.clipboard.writeText(url).then(() => {
        const originalText = btn.textContent;
        btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          const originalText = btn.textContent;
          btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        } catch (e) {
          alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URL: ' + url);
        }
        document.body.removeChild(textarea);
      });
    }
    
    // ã€è¿½åŠ ã€‘ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å ´åˆã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½ç½®ã‚’èª¿æ•´ï¼ˆç”»é¢ä¸‹éƒ¨ã«é…ç½®ï¼‰
    (function adjustDialogPosition(){
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆè¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      try {
        if (window.parent && window.parent !== window) {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å ´åˆã€ä½ç½®ã‚’èª¿æ•´
          // æ³¨æ„: Google Apps Scriptã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã€ç›´æ¥çš„ãªä½ç½®åˆ¶å¾¡ã¯ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ‰‹å‹•ã§ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•ã§ãã¾ã™
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ã—ã¦é–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’ç§»å‹•ã§ãã¾ã™ã€‚');
        }
      } catch(e) {
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆ
        console.log('ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã¨ã—ã¦é–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚');
      }
    })();

    function setBusy(on){
      busy = on;
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºæ™‚ã®ã¿æœ‰åŠ¹åŒ–ï¼‰
      // console.log('setBusy(' + on + ') called');
      const nodes = document.querySelectorAll('button, input, a.btn');
      nodes.forEach(node=>{
        if (node.id === 'manual') return; // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã¯å¸¸æ™‚å¤‰æ›´å¯
        if (node.tagName === 'A') {
          if (on) {
            node.classList.add('disabled');
          } else {
            node.classList.remove('disabled');
          }
        } else {
          node.disabled = on;
        }
      });
      // ç¢ºå®Ÿã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«å¼·åˆ¶çš„ã«æ›´æ–°
      if (!on) {
        // å‡¦ç†å®Œäº†æ™‚ã¯ã€ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«æœ‰åŠ¹åŒ–ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
        nodes.forEach(node=>{
          if (node.id === 'manual') return;
          if (node.tagName === 'A') {
            node.classList.remove('disabled');
          } else {
            node.disabled = false;
          }
        });
        // å¿µã®ãŸã‚ã€setTimeoutã§ã‚‚å†åº¦å®Ÿè¡Œ
        setTimeout(() => {
          document.querySelectorAll('button, input, a.btn').forEach(node=>{
            if (node.id === 'manual') return;
            if (node.tagName === 'A') {
              node.classList.remove('disabled');
            } else {
              node.disabled = false;
            }
          });
        }, 50);
      }
    }

    // æ¥ç¶šãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
    (function pingOnce(){
      google.script.run
        .withSuccessHandler(()=>{ const n = document.getElementById('connLight'); if(n) n.textContent = 'æ¥ç¶š: OK'; })
        .withFailureHandler(e => { const n = document.getElementById('connLight'); if(n) n.textContent = 'æ¥ç¶š: å¤±æ•—('+ String(e) +')'; })
        .admin_ping();
    })();

    // ç–é€šãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
    try {
      google.script.run
        .withSuccessHandler(()=>console.log('ping ok'))
        .withFailureHandler(e=>console.warn('ã‚µãƒ¼ãƒç–é€šå¤±æ•—', e))
        .admin_ping();
    } catch (e) {
      console.warn('ã‚µãƒ¼ãƒç–é€šå‘¼ã³å‡ºã—ã§ä¾‹å¤–', e);
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const name = t.dataset.tab;
        el('panel-admin').style.display = (name==='admin')?'':'none';
        el('panel-draw').style.display  = (name==='draw') ?'':'none';
        
        // ã€è¿½åŠ ã€‘ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹/åœæ­¢
        if (dataUpdateCheckInterval) {
          clearInterval(dataUpdateCheckInterval);
          dataUpdateCheckInterval = null;
        }
        
        if (name==='admin') {
          loadAdmin();
          // ã€è¿½åŠ ã€‘é‹å–¶ã‚¿ãƒ–ã§ã‚‚ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ï¼ˆ1ç§’é–“éš”ï¼‰
          startDataUpdateCheck();
        } else {
          loadDraw();
          // ã€è¿½åŠ ã€‘ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ï¼ˆ1ç§’é–“éš”ï¼‰
          startDataUpdateCheck();
        }
      };
    });

    // ===== é‹å–¶ã‚¿ãƒ– =====
    function loadAdmin(){
      el('status').innerHTML =
        '<div class="kvs">'
        + '<div>Round/Sub</div><div><b>â€¦</b> / <b>â€¦</b></div>'
        + '<div>å—ä»˜</div><div>ç¢ºèªä¸­â€¦</div>'
        + '</div>'
        + '<div class="muted" style="margin-top:6px">ï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰</div>';
      
      // ã€è¿½åŠ ã€‘ãƒªãƒ³ã‚¯ã‚’åˆæœŸåŒ–
      el('formLink').dataset.url = '#';
      el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
      el('editLink').dataset.url = '#';
      el('editLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†';

      google.script.run.withSuccessHandler(s=>{
        el('status').innerHTML =
          `<div class="kvs">
            <div>Round/Sub</div><div><b>${s.round}</b> / <b>${s.sub}</b></div>
            <div>å—ä»˜</div><div>${s.form && s.form.accepting ? 'ğŸŸ¢ å—ä»˜ä¸­' : 'âšª åœæ­¢ä¸­'}</div>
            <div>ãƒ‰ãƒ©ãƒ•ãƒˆæº–å‚™</div><div>${s.form && s.form.isReady ? 'âœ… å®Œäº†' : 'âŒ æœªå®Œäº†'}</div>
          </div>
          <div class="muted" style="margin-top:6px">ï¼ˆç°¡æ˜“è¡¨ç¤ºï¼šè©³ç´°å–å¾—ä¸­â€¦ï¼‰</div>`;
        // ã€ä¿®æ­£ã€‘ç°¡æ˜“è¡¨ç¤ºã§ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã‚’è¨­å®š
        if (s.form) {
          if (s.form.formUrl) {
            el('formLink').dataset.url = s.form.formUrl;
            el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
          } else {
            el('formLink').dataset.url = '#';
            el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ æœªè¨­å®š';
          }
          if (s.form.editUrl) {
            el('editLink').dataset.url = s.form.editUrl;
            el('editLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†';
          } else {
            el('editLink').dataset.url = '#';
            el('editLink').textContent = 'ç·¨é›†URLæœªè¨­å®š';
          }
        } else {
          el('formLink').dataset.url = '#';
          el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ æœªè¨­å®š';
          el('editLink').dataset.url = '#';
          el('editLink').textContent = 'ç·¨é›†URLæœªè¨­å®š';
        }

        const token = Date.now(); window.__adminFullWD = token;
        const wd = setTimeout(()=>{
          if (window.__adminFullWD === token) {
            el('status').innerHTML += '<div class="muted">ï¼ˆè©³ç´°ãŒé…å»¶/å¤±æ•—ã€‚ç°¡æ˜“è¡¨ç¤ºã®ã¾ã¾æ“ä½œã§ãã¾ã™ï¼‰</div>';
          }
        }, 8000);

        google.script.run.withSuccessHandler(full=>{
          clearTimeout(wd);
          el('status').innerHTML =
            `<div class="kvs">
              <div>Round/Sub</div><div><b>${full.round}</b> / <b>${full.sub}</b></div>
              <div>å—ä»˜</div><div>${full.form && full.form.accepting ? 'ğŸŸ¢ å—ä»˜ä¸­' : 'âšª åœæ­¢ä¸­'}</div>
              <div>ãƒ‰ãƒ©ãƒ•ãƒˆæº–å‚™</div><div>${full.form && full.form.isReady ? 'âœ… å®Œäº†' : 'âŒ æœªå®Œäº†'}</div>
              <div>Eligible</div><div>${full.eligibleCount}å</div>
              <div>ä»Šã‚µãƒ–ã®æå‡º</div><div>${full.submittedCount}ä»¶</div>
              <div>å›ç­”ã‚¿ãƒ–</div><div>${full.form && full.form.respName ? full.form.respName : '-'}</div>
              <div>æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰</div><div>${full.manualMode ? 'ON' : 'OFF'}</div>
            </div>
            <div class="muted" style="margin-top:6px">Eligible: ${(full.eligible||[]).join(', ')||'-'}</div>
            ${ full.errors && full.errors.length ? '<div class="muted" style="margin-top:6px;color:#b00">è¨ºæ–­: '+full.errors.join(' | ')+'</div>' : '' }
            ${ !full.form || !full.form.isReady ? '<div class="muted" style="margin-top:6px;color:#b00">âš  ãƒ‰ãƒ©ãƒ•ãƒˆæº–å‚™ãŒæœªå®Œäº†ã§ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ‰ãƒ©ãƒ•ãƒˆæº–å‚™ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>' : '' }
            `;
          // ã€ä¿®æ­£ã€‘ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã®URLã‚’è¨­å®šï¼ˆè©³ç´°å–å¾—ã§ã‚‚ç¢ºå®Ÿã«è¨­å®šï¼‰
          if (full.form) {
            if (full.form.formUrl) {
              el('formLink').dataset.url = full.form.formUrl;
              el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
            } else {
              el('formLink').dataset.url = '#';
              el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ æœªè¨­å®š';
            }
            if (full.form.editUrl) {
              el('editLink').dataset.url = full.form.editUrl;
              el('editLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†';
            } else {
              el('editLink').dataset.url = '#';
              el('editLink').textContent = 'ç·¨é›†URLæœªè¨­å®š';
            }
          } else {
            el('formLink').dataset.url = '#';
            el('formLink').textContent = 'ãƒ•ã‚©ãƒ¼ãƒ æœªè¨­å®š';
            el('editLink').dataset.url = '#';
            el('editLink').textContent = 'ç·¨é›†URLæœªè¨­å®š';
          }
          // ã€ä¿®æ­£ã€‘æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸ
          if (el('manual')) {
            el('manual').checked = !!full.manualMode;
          }
        }).withFailureHandler(e=>{
          clearTimeout(wd);
          el('status').innerHTML += `<div class="muted" style="color:#b00">è©³ç´°å–å¾—å¤±æ•—: ${esc(e)}</div>`;
        }).admin_getStatus();

      }).withFailureHandler(e=>{
        el('status').innerHTML =
          `<div style="color:#b00">ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—: ${esc(e)}</div>
          <div class="muted">æ¨©é™ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œãƒˆãƒªã‚¬ãƒ¼å†ä½œæˆã€ã‚‚è©¦ã—ã¦ãã ã•ã„ã€‚</div>`;
      }).admin_getStatus_fast();
    }

    // é‹å–¶ãƒœã‚¿ãƒ³
    (function wireAdmin(){
      el('open').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_openRoundSafe(); };

      el('close').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_closeRoundSafe(); };

      el('resolve').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_resolve(); };

      // ã€å‰Šé™¤ã€‘Requestsã‚·ãƒ¼ãƒˆãŒãªããªã£ãŸãŸã‚ã€è£œå®Œæ©Ÿèƒ½ã¨çŸ›ç›¾ç¢ºèªæ©Ÿèƒ½ã¯ä¸è¦

      el('rebuild').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ alert('ãƒˆãƒªã‚¬ãƒ¼å†ä½œæˆ'); setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_rebuildTrigger(); };

      el('sync').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_syncChoicesSafe(); };

      el('compact').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ alert('å›ç­”ã‚¿ãƒ–ã‚’åœ§ç¸®ã—ã¾ã—ãŸ'); setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_compact(); };

      el('reset').onclick = ()=>{ if(busy) return; if(!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nï¼ˆRound/Subã€æŒ‡åãƒ‡ãƒ¼ã‚¿ã€ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãªã©ãŒå…¨ã¦åˆæœŸåŒ–ã•ã‚Œã¾ã™ï¼‰')) return;
        setBusy(true);
        google.script.run.withSuccessHandler(()=>{ alert('å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†'); setBusy(false); loadAdmin(); })
          .withFailureHandler(e=>{alert(e); setBusy(false);}).admin_resetAllSafe(); };

      el('importCaptains').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(result=>{
          if (result && result.success) {
            alert(`Captainsã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\n\nã‚¤ãƒ³ãƒãƒ¼ãƒˆä»¶æ•°: ${result.count}ä»¶\n\nï¼ˆãƒãƒ¼ãƒ åãƒ»XPã‚‚è»¢è¨˜ã•ã‚Œã¾ã—ãŸï¼‰`);
          } else if (result && result.error) {
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„
            if (result.error !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ') {
              alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + result.error);
            }
          }
          // alert()ã®å¾Œã«setBusy(false)ã¨loadAdmin()ã‚’å‘¼ã¶ï¼ˆUIã‚’ç¢ºå®Ÿã«æ›´æ–°ï¼‰
          busy = false;
          setBusy(false);
          loadAdmin();
        }).withFailureHandler(e=>{
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: '+e);
          busy = false;
          setBusy(false);
          loadAdmin();
        }).admin_importCaptains(); };

      el('importPlayers').onclick = ()=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(result=>{
          if (result && result.success) {
            alert(`Playersã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\n\nã‚¤ãƒ³ãƒãƒ¼ãƒˆä»¶æ•°: ${result.count}ä»¶\n\nï¼ˆã‚¨ãƒªã‚¢XPãƒ»æŒã¡ãƒ–ã‚­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚‚è»¢è¨˜ã•ã‚Œã¾ã—ãŸï¼‰`);
          } else if (result && result.error) {
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„
            if (result.error !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ') {
              alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + result.error);
            }
          }
          // alert()ã®å¾Œã«setBusy(false)ã¨loadAdmin()ã‚’å‘¼ã¶ï¼ˆUIã‚’ç¢ºå®Ÿã«æ›´æ–°ï¼‰
          busy = false;
          setBusy(false);
          loadAdmin();
        }).withFailureHandler(e=>{
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: '+e);
          busy = false;
          setBusy(false);
          loadAdmin();
        }).admin_importPlayers(); };

      el('manual').onchange = (e)=>{ if(busy) return; setBusy(true);
        google.script.run.withSuccessHandler(()=>{ setBusy(false); loadAdmin(); })
          .withFailureHandler(err=>{ alert(err); setBusy(false); loadAdmin(); })
          .admin_setManualMode(e.target.checked);
      };

      el('setEligible').onclick = ()=>{ if(busy) return;
        const csv = el('eligibleCsv').value;
        setBusy(true);
        google.script.run.withSuccessHandler(names=>{ alert('Eligibleæ›´æ–°: '+(names.join(', ')||'-')); setBusy(false); loadAdmin(); })
          .withFailureHandler(err=>{ alert(err); setBusy(false); })
          .admin_setEligibleCaptainsCSV(csv);
      };

      el('setRS').onclick = ()=>{ if(busy) return;
        const r = Number(el('round').value||1), s = Number(el('sub').value||1);
        setBusy(true);
        google.script.run.withSuccessHandler(v=>{ alert(`Round/Sub ã‚’ ${v.round}/${v.sub} ã«è¨­å®šã—ã¾ã—ãŸ`); setBusy(false); loadAdmin(); })
          .withFailureHandler(err=>{ alert(err); setBusy(false); })
          .admin_setRoundSub(r, s);
      };
    })();

    // ===== æŠ½é¸ã‚¿ãƒ– =====
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã«æ›´æ–°
    function setDrawSummaryLoading() {
      const sum = el('summary');
      if (!sum) return;
      sum.innerHTML = `æ›´æ–°ä¸­â€¦<br>${sum.innerHTML || ''}`;
    }

    // æœªæå‡ºè€…ãŒã„ã‚‹å ´åˆã®è¡¨ç¤º
    function renderDrawWaitingState(round, sub, waitingCount) {
      const summary = el('summary');
      const singlesCard = el('singles');
      const singlesList = el('singlesList');
      const contestsCard = el('contests');
      const contestList = el('contestList');

      if (summary) {
        summary.innerHTML =
          `Round ${round} / Sub ${sub} `
          + `<span class="pill" style="background:#faa;">æœªæå‡º:${waitingCount}å</span> `
          + `<div style="margin-top:8px; color:#666;">å…¨æŒ‡åãŒæƒã†ã¾ã§å¾…æ©Ÿä¸­...</div>`;
      }

      if (singlesCard) singlesCard.style.display = 'none';
      if (singlesList) singlesList.innerHTML = '';
      if (contestsCard) contestsCard.style.display = 'none';
      if (contestList) contestList.innerHTML = '';

      // æœªæå‡ºè€…æ•°ã‚’è¨˜éŒ²ï¼ˆæ—¢å­˜æŒ™å‹•ã‚’ç¶­æŒï¼‰
      lastKnownWaitingCount = waitingCount;
    }

    // å˜ç‹¬æŒ‡åã®æç”»
    function renderSinglesSection(singles) {
      const singlesCard = el('singles');
      const singlesList = el('singlesList');

      if (!singlesCard || !singlesList) return;

      if (singles.length) {
        singlesCard.style.display = '';
        singlesList.innerHTML = singles
          .map(s => `ğŸ¯ <b>${esc(s.player)}</b> â†’ <b>${esc(s.captain)}</b>`)
          .map(line => `<div>${line}</div>`)
          .join('');
      } else {
        singlesCard.style.display = 'none';
        singlesList.innerHTML = '';
      }
    }

    // ç«¶åˆæŠ½é¸ã®æç”»
    function renderContestsSection(contests) {
      const contestsCard = el('contests');
      const contestList = el('contestList');

      if (!contestsCard || !contestList) return;

      if (contests.length) {
        contestsCard.style.display = '';
        contestList.innerHTML = contests.map(c => renderContest(c)).join('');
        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼µã‚Šç›´ã™
        wireRollButtons();
      } else {
        contestsCard.style.display = 'none';
        contestList.innerHTML = '';
      }
    }

    // å…¨æŒ‡åãŒæƒã£ãŸå ´åˆã®è¡¨ç¤º
    function renderDrawResolvedState(round, sub, singles, contests) {
      const summary = el('summary');

      if (summary) {
        summary.innerHTML =
          `Round ${round} / Sub ${sub} `
          + `<span class="pill">å˜ç‹¬:${singles.length}</span> `
          + `<span class="pill">ç«¶åˆ:${contests.length}</span>`;
      }

      renderSinglesSection(singles);
      renderContestsSection(contests);

      // æœªæå‡ºè€…ã¯ã„ãªã„çŠ¶æ…‹
      lastKnownWaitingCount = 0;
    }

    function loadDraw() {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      setDrawSummaryLoading();

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
      const token = Date.now();
      window.__drawWD = token;

      const wd = setTimeout(() => {
        if (window.__drawWD === token) {
          setBusy(false);
        }
      }, 5000);

      google.script.run.withSuccessHandler(info => {
        clearTimeout(wd);

        const { round, sub, contests, singles, waiting } = info;

        if (waiting.length > 0) {
          // æœªæå‡ºè€…ãŒã„ã‚‹å ´åˆï¼šå¾…æ©Ÿè¡¨ç¤º
          renderDrawWaitingState(round, sub, waiting.length);
        } else {
          // å…¨æŒ‡åãŒæƒã£ãŸå ´åˆã®ã¿ã€å˜ç‹¬ãƒ»ç«¶åˆã‚’è¡¨ç¤º
          renderDrawResolvedState(round, sub, singles, contests);
        }

        // èª­ã¿è¾¼ã¿å®Œäº†
        setBusy(false);
      }).withFailureHandler(err => {
        clearTimeout(wd);
        alert('èª­ã¿è¾¼ã¿å¤±æ•—: ' + err);
        setBusy(false);
      }).draft_getCurrentContests();
    }

    function renderContest(c){
      const caps = c.captains.map(x=>`${esc(x.name)}ï¼ˆå„ªå…ˆPt:${x.prio}ï¼‰`).join(' / ');
      return `
        <div class="card">
          <div>ğŸ² å¯¾è±¡: <b>${esc(c.player)}</b></div>
          <div>å€™è£œ: ${caps}</div>
          <div class="roulette-wrap">
            <div class="roulette-strip" id="strip-${cssId(c.player)}"></div>
            <div class="pointer"></div>
          </div>
          <div class="row" style="justify-content:space-between">
            <button class="btn rollBtn" data-player="${htmlAttr(c.player)}">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
            <span id="res-${cssId(c.player)}" class="muted">æº–å‚™OK</span>
          </div>
        </div>
      `;
    }

    function wireRollButtons(){
      // DOMæ›´æ–°ã‚’å¾…ã¤ãŸã‚ã€å°‘ã—é…å»¶ã•ã›ã‚‹
      setTimeout(() => {
        Array.from(document.querySelectorAll('.rollBtn')).forEach(btn=>{
          if (btn) { // nullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
            btn.onclick = ()=>{
              if (busy) return;
              const player = btn.dataset.player;
              spinRoulette(player, btn);
            };
          }
        });
      }, 10);
    }

    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡ºï¼ˆå„ªå…ˆPtæœ€å¤§ã¯è‡ªå‹•ç¢ºå®šï¼åŒç‡ã®ã¿æŠ½é¸ï¼‰
    function spinRoulette(player, btn){
      setBusy(true);
      const strip = el('strip-'+cssId(player));
      const res   = el('res-'+cssId(player));
      
      // ã€è¿½åŠ ã€‘è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      if (!strip || !res) {
        alert('ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        setBusy(false);
        loadDraw(); // ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
        return;
      }

      google.script.run.withSuccessHandler(data=>{
        // ã€è¿½åŠ ã€‘è¦ç´ ãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹å†ç¢ºèªï¼ˆloadDraw()ãŒå‘¼ã°ã‚ŒãŸå ´åˆã«å‚™ãˆã‚‹ï¼‰
        const currentStrip = el('strip-'+cssId(player));
        const currentRes = el('res-'+cssId(player));
        if (!currentStrip || !currentRes) {
          // è¦ç´ ãŒæ¶ˆãˆã¦ã„ã‚‹å ´åˆã¯ã€ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
          setBusy(false);
          loadDraw();
          return;
        }
        
        const per = data.perItemPx || 120;
        const wheel = data.wheel && data.wheel.length ? data.wheel : [data.winner];

        currentStrip.innerHTML = '';
        const totalItems = data.stopIndex + 8;
        for (let i=0;i<totalItems;i++){
          const name = wheel[i % wheel.length];
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = name;
          chip.style.minWidth = per+'px';
          currentStrip.appendChild(chip);
        }

        currentStrip.style.transform = 'translateX(0px)';
        currentStrip.style.transition = 'none';

        requestAnimationFrame(()=>{
          // ã€è¿½åŠ ã€‘è¦ç´ ãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹å†ç¢ºèª
          const finalStrip = el('strip-'+cssId(player));
          const finalRes = el('res-'+cssId(player));
          if (!finalStrip || !finalRes) {
            setBusy(false);
            loadDraw();
            return;
          }
          
          const wrapWidth = finalStrip.parentElement ? finalStrip.parentElement.clientWidth : 400;
          const targetCenter = data.stopIndex * per + per/2;
          const translate = -(targetCenter - wrapWidth/2);
          const duration = data.isTie ? 4000 : 800; // åŒç‡æŠ½é¸ã¯é•·ã‚ã«ï¼ˆ4000msï¼‰ã€è‡ªå‹•ç¢ºå®šã¯çŸ­ãï¼ˆ800msï¼‰

          finalStrip.style.transition = `transform ${duration}ms cubic-bezier(0.17, 0.84, 0.44, 1)`;
          finalStrip.style.transform = `translateX(${translate}px)`;

          // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒæ­¢ã¾ã£ãŸæ™‚ç‚¹ã§å³åº§ã«çµæœã‚’è¡¨ç¤ºï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
          setTimeout(()=>{
            // ã€è¿½åŠ ã€‘è¦ç´ ãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹å†ç¢ºèª
            const resultStrip = el('strip-'+cssId(player));
            const resultRes = el('res-'+cssId(player));
            if (!resultStrip || !resultRes) {
              setBusy(false);
              loadDraw();
              return;
            }
            
            const note = data.isTie ? 'ï¼ˆåŒç‡æŠ½é¸ï¼‰' : 'ï¼ˆå„ªå…ˆPtã§è‡ªå‹•ç¢ºå®šï¼‰';
            resultRes.innerHTML = `<span class="winner">${esc(data.winner)}</span> ã«ç¢ºå®š ${note}`;
            btn.style.display = 'none'; // ç¢ºå®šæ¸ˆã¿ãªã®ã§ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            setBusy(false); // å³åº§ã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¬¡ã®æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰
            
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆå®Œå…¨ã«éåŒæœŸã€UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            google.script.run.withSuccessHandler(()=>{
              // å‡¦ç†å®Œäº†å¾Œã€å³åº§ã«ç”»é¢ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’å¾…ãŸãªã„ï¼‰
              loadDraw();
            }).withFailureHandler(err=>{
              // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç”»é¢ã‚’æ›´æ–°
              alert('ã‚³ãƒŸãƒƒãƒˆå¤±æ•—: '+err);
              loadDraw();
            }).draft_commitPick(player, data.winner, data.isTie ? 'æŠ½é¸(æ‰‹å‹•:åŒç‡ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ)' : 'æŠ½é¸(æ‰‹å‹•:å„ªå…ˆPtè‡ªå‹•)');
          }, duration + 60);
        });
      }).withFailureHandler(err=>{
        alert('ãƒ­ãƒ¼ãƒ«å¤±æ•—: '+err);
        setBusy(false);
      }).draft_rollOne(player);
    }

    // å˜ç‹¬ç¢ºå®š / é€²è¡Œ / å†èª­ã¿è¾¼ã¿
    (function wireDrawOps(){
      const commitBtn = el('commitSinglesBtn');
      if (commitBtn) {
        commitBtn.onclick = ()=>{
          if (busy) return;
          setBusy(true);
          google.script.run.withSuccessHandler(cnt=>{
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã›ãšã€ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã ã‘
            setBusy(false);
            loadDraw();
          }).withFailureHandler(err=>{
            alert('å˜ç‹¬ç¢ºå®šå¤±æ•—: '+err);
            setBusy(false);
            loadDraw();
          }).draft_commitSingles();
        };
      }

      const advanceBtn = el('advanceBtn');
      if (advanceBtn) {
        advanceBtn.onclick = ()=>{
          if (busy) return;
          setBusy(true);
          // ã€æœ€é©åŒ–ã€‘å³åº§ã«UIã‚’æ›´æ–°ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
          const originalText = advanceBtn.textContent;
          advanceBtn.textContent = 'å‡¦ç†ä¸­...';
          advanceBtn.disabled = true;
          
          google.script.run.withSuccessHandler(()=>{
            advanceBtn.textContent = originalText;
            advanceBtn.disabled = false;
            setBusy(false);
            loadDraw();
          }).withFailureHandler(err=>{
            alert('é€²è¡Œå¤±æ•—: '+err);
            advanceBtn.textContent = originalText;
            advanceBtn.disabled = false;
            setBusy(false);
            loadDraw();
          }).draft_advanceAfterManual();
        };
      }

      // refreshBtnã¯å­˜åœ¨ã—ãªã„ãŸã‚å‰Šé™¤
    })();

    // utils
    function cssId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }
    function htmlAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ã€è¿½åŠ ã€‘ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚„Requestsã‚·ãƒ¼ãƒˆã®å¤‰æ›´ã‚’æ¤œçŸ¥ï¼‰
    let lastKnownWaitingCount = -1; // å‰å›ã®æœªæå‡ºè€…æ•°ã‚’è¨˜éŒ²
    
    function startDataUpdateCheck(){
      if (dataUpdateCheckInterval) return; // æ—¢ã«é–‹å§‹æ¸ˆã¿
      
      // åˆå›ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
      google.script.run.withSuccessHandler(status=>{
        lastKnownTimestamp = status.lastUpdateTimestamp || '';
      }).admin_getStatus_fast();
      
      // 2ç§’é–“éš”ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚é–“éš”ã‚’å»¶é•·ï¼‰
      dataUpdateCheckInterval = setInterval(()=>{
        if (busy) return;
        
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–ã«å¿œã˜ã¦æ›´æ–°
        const isAdminTab = el('panel-admin').style.display !== 'none';
        const isDrawTab = el('panel-draw').style.display !== 'none';
        
        if (!isAdminTab && !isDrawTab) return; // ã©ã¡ã‚‰ã®ã‚¿ãƒ–ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„
        
        google.script.run.withSuccessHandler(status=>{
          const currentTimestamp = status.lastUpdateTimestamp || '';
          if (currentTimestamp && currentTimestamp !== lastKnownTimestamp) {
            lastKnownTimestamp = currentTimestamp;
            // è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–ã«å¿œã˜ã¦å†èª­ã¿è¾¼ã¿
            if (isAdminTab) {
              loadAdmin(); // é‹å–¶ã‚¿ãƒ–ã®è¡¨ç¤ºã‚’æ›´æ–°
            }
            if (isDrawTab) {
              // æŠ½é¸ã‚¿ãƒ–ã®å ´åˆã€ç›´æ¥loadDraw()ã‚’å‘¼ã³å‡ºã™ï¼ˆloadDraw()å†…ã§waitingã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ï¼‰
              // å…¨æŒ‡åãŒæƒã†ã¾ã§ã¯loadDraw()å†…ã§éè¡¨ç¤ºã«ãªã‚‹
              loadDraw();
            }
          }
        }).withFailureHandler(()=>{
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç„¡è¦–ï¼ˆæ¬¡å›ã®ãƒã‚§ãƒƒã‚¯ã§å†è©¦è¡Œï¼‰
        }).admin_getStatus_fast();
      }, 2000);
    }

    // åˆæœŸè¡¨ç¤ºï¼šé‹å–¶ã‚¿ãƒ–
    loadAdmin();
    // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
    startDataUpdateCheck();
  </script>
</body>
</html>

