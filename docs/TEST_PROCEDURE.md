# Splatoon3 ドラフトツール 詳細テスト手順書

## 目次
1. [初期設定・準備テスト](#1-初期設定準備テスト)
2. [基本機能テスト（自動モード）](#2-基本機能テスト自動モード)
3. [手動モードテスト](#3-手動モードテスト)
4. [バグ修正項目の確認テスト](#4-バグ修正項目の確認テスト)
5. [エッジケース・エラー処理テスト](#5-エッジケースエラー処理テスト)
6. [UIテスト](#6-uiテスト)
7. [統合テスト](#7-統合テスト)

---

## 1. 初期設定・準備テスト

### 1.1 データ準備テスト

#### テストケース 1.1.1: Playersシートの準備
**前提条件**: スプレッドシートが開いている

**手順**:
1. `Players`シートを作成（存在しない場合）
2. ヘッダー行に以下を入力: `Name`, `Status`, `Memo`, `エリアXP`, `持ちブキ`, `コメント`
3. テストデータを追加:
   ```
   Name    | Status | Memo | エリアXP | 持ちブキ | コメント
   Player1 | active |      | 1000     | スプラシューター |
   Player2 | active |      | 2000     | チャージャー |
   Player3 | active |      | 1500     | ローラー |
   Player4 | inactive |    | 500      | スプラシューター |
   ```

**期待結果**:
- `Players`シートが作成される
- ヘッダーが正しく設定される
- データが入力される

**確認ポイント**:
- `Status`が`active`の選手のみが対象になることを確認（後続テストで）

---

#### テストケース 1.1.2: Captainsシートの準備
**前提条件**: スプレッドシートが開いている

**手順**:
1. `Captains`シートを作成（存在しない場合）
2. ヘッダー行に以下を入力: `Captain`, `Team`, `Prio`, `XP`
3. テストデータを追加:
   ```
   Captain | Team | Prio | XP
   Cap1    | TeamA | 0   | 5000
   Cap2    | TeamB | 0   | 4500
   Cap3    | TeamC | 0   | 4000
   ```

**期待結果**:
- `Captains`シートが作成される
- ヘッダーが正しく設定される
- データが入力される

**確認ポイント**:
- 初期`Prio`が0であることを確認

---

### 1.2 フォーム作成テスト

#### テストケース 1.2.1: setupDraft()の実行
**前提条件**: 
- `Players`シートに`Status=active`の選手が3人以上
- `Captains`シートにキャプテンが3人以上

**手順**:
1. スプレッドシートのメニューから「ドラフト運営」→「ドラフト準備（フォーム作成＆トリガー再作成）」を実行
2. エラーが発生しないことを確認

**期待結果**:
- Googleフォームが作成される
- `Config`シートに`FORM_ID`が設定される
- `ROUND=1`, `SUBROUND=1`が設定される
- `ELIGIBLE_CAPTAINS`に全キャプテンが設定される
- `onFormSubmit`トリガーが作成される
- `Log`シートに`SETUP`イベントが記録される

**確認ポイント**:
- `Config`シートの値を確認
- トリガーが正しく作成されているか確認（「拡張機能」→「トリガー」）
- `Log`シートにイベントが記録されているか確認

---

#### テストケース 1.2.2: フォームの内容確認
**前提条件**: `setupDraft()`が正常に完了

**手順**:
1. `Config`シートから`FORM_ID`を取得
2. フォームを開く
3. フォームの内容を確認

**期待結果**:
- フォームタイトルが「Splatoon3 ドラフト会議 - [スプレッドシート名]」
- 「キャプテン」の選択肢に全キャプテンが表示される
- 「指名する選手」の選択肢に`Status=active`の選手のみが表示される
- フォームが回答を受け付けていない状態（`IS_OPEN=0`）

**確認ポイント**:
- 選択肢が正しく設定されているか
- フォームの説明文が正しいか

---

## 2. 基本機能テスト（自動モード）

### 2.1 ラウンド開始テスト

#### テストケース 2.1.1: ラウンド開始（自動モード）
**前提条件**: 
- フォームが作成済み
- 手動モードがOFF（`MANUAL_MODE=0`）

**手順**:
1. 運営センターを開く（メニュー「ドラフト運営」→「運営センターを開く」）
2. 「受付開始」ボタンをクリック
3. フォームの状態を確認

**期待結果**:
- フォームが回答を受け付ける状態になる
- `Config`の`IS_OPEN=1`になる
- `ELIGIBLE_CAPTAINS`に全キャプテンが設定される
- `SUBROUND=1`になる
- `Log`シートに`ROUND_OPEN`イベントが記録される
- 運営センターのステータスに「🟢 受付中」と表示される

**確認ポイント**:
- フォームのURLを開いて回答を受け付けられるか確認
- `Config`シートの値を確認
- `Log`シートを確認

---

### 2.2 単独指名テスト

#### テストケース 2.2.1: 単独指名の自動確定
**前提条件**: 
- Round 1, Sub 1が開始済み
- キャプテン3人（Cap1, Cap2, Cap3）
- 選手3人（Player1, Player2, Player3）

**手順**:
1. Cap1がフォームでPlayer1を指名
2. Cap2がフォームでPlayer2を指名
3. Cap3がフォームでPlayer3を指名
4. 各提出後に`Requests`シートを確認
5. 全キャプテンの提出後に`Picks`シートを確認

**期待結果**:
- 各提出が`Requests`シートに記録される
- 全キャプテンの提出が揃うと自動で解決される
- `Picks`シートに以下が記録される:
  - Cap1 → Player1 (方法: `通常(第1希望)`)
  - Cap2 → Player2 (方法: `通常(第1希望)`)
  - Cap3 → Player3 (方法: `通常(第1希望)`)
- `Teams`シートが更新される
- `Log`シートに`SUBROUND_RESOLVED`イベントが記録される
- Round 2, Sub 1が自動で開始される

**確認ポイント**:
- `Picks`シートの内容を確認
- `Teams`シートが正しく更新されているか確認
- `Log`シートを確認
- 次のラウンドが開始されているか確認

---

### 2.3 競合テスト

#### テストケース 2.3.1: 競合時の優先ポイント自動勝利
**前提条件**: 
- Round 1, Sub 1が開始済み
- Cap1のPrio=2, Cap2のPrio=1, Cap3のPrio=0

**手順**:
1. Cap1がフォームでPlayer1を指名
2. Cap2がフォームでPlayer1を指名（競合）
3. Cap3がフォームでPlayer2を指名
4. 全キャプテンの提出後に`Picks`シートを確認

**期待結果**:
- Cap1がPlayer1を獲得（優先ポイント最大）
- `Picks`シートに記録: Cap1 → Player1 (方法: `抽選(第1希望)`)
- Cap2のPrioが+1されて2になる
- Cap3のPrioは変更されない
- `Log`シートに`PRIO_UP`イベントが記録される

**確認ポイント**:
- `Picks`シートを確認
- `Captains`シートでCap2のPrioが2になっているか確認
- `Log`シートを確認

---

#### テストケース 2.3.2: 競合時の同率抽選
**前提条件**: 
- Round 1, Sub 1が開始済み
- Cap1のPrio=1, Cap2のPrio=1, Cap3のPrio=0

**手順**:
1. Cap1がフォームでPlayer1を指名
2. Cap2がフォームでPlayer1を指名（競合、同率）
3. Cap3がフォームでPlayer2を指名
4. 全キャプテンの提出後に`Picks`シートを確認

**期待結果**:
- Cap1またはCap2のどちらかがPlayer1を獲得（ランダム）
- 敗者のPrioが+1される
- `Picks`シートに記録: 勝者 → Player1 (方法: `抽選(第1希望)`)

**確認ポイント**:
- 抽選が正しく実行されているか確認
- 敗者のPrioが更新されているか確認

---

### 2.4 サブラウンド進行テスト

#### テストケース 2.4.1: サブラウンドの自動進行
**前提条件**: 
- Round 1, Sub 1でCap1とCap2が選手を獲得
- Cap3は未獲得
- 残り選手が存在

**手順**:
1. Sub 1の解決を待つ
2. `Config`シートで`SUBROUND`を確認
3. フォームの状態を確認

**期待結果**:
- `SUBROUND=2`になる
- `ELIGIBLE_CAPTAINS`にCap3のみが設定される
- フォームのキャプテン選択肢にCap3のみが表示される
- フォームが回答を受け付ける状態になる
- `Log`シートに`SUBROUND_OPEN`イベントが記録される

**確認ポイント**:
- `Config`シートの値を確認
- フォームを開いて選択肢を確認
- `Log`シートを確認

---

## 3. 手動モードテスト

### 3.1 手動モード切り替えテスト

#### テストケース 3.1.1: 手動モードの有効化
**前提条件**: フォームが作成済み

**手順**:
1. 運営センターを開く
2. 「手動モード（抽選はUIで進行）」チェックボックスにチェック
3. `Config`シートで`MANUAL_MODE`を確認

**期待結果**:
- `MANUAL_MODE=1`になる
- 運営センターのステータスに「手動モード: ON」と表示される
- `Log`シートに`ADMIN`イベント（`manualMode=ON`）が記録される

**確認ポイント**:
- `Config`シートを確認
- 運営センターの表示を確認

---

### 3.2 手動抽選テスト

#### テストケース 3.2.1: 手動モードでの競合抽選
**前提条件**: 
- 手動モードがON
- Round 1, Sub 1で競合が発生

**手順**:
1. 複数のキャプテンが同じ選手を指名
2. 運営センターの「抽選」タブを開く
3. 競合リストを確認
4. 「ルーレット開始」ボタンをクリック
5. ルーレットアニメーションを確認
6. 結果を確認

**期待結果**:
- 抽選タブに競合が表示される
- ルーレットが回転する
- 勝者が確定される
- `Picks`シートに記録される
- 敗者のPrioが+1される
- 抽選タブが更新される

**確認ポイント**:
- ルーレットアニメーションが正しく動作するか
- `Picks`シートを確認
- `Captains`シートでPrioが更新されているか確認

---

#### テストケース 3.2.2: 単独指名のまとめて確定
**前提条件**: 
- 手動モードがON
- 単独指名が複数存在

**手順**:
1. 運営センターの「抽選」タブを開く
2. 単独指名リストを確認
3. 「単独をまとめて確定」ボタンをクリック
4. `Picks`シートを確認

**期待結果**:
- 単独指名が一括で`Picks`シートに記録される
- `Teams`シートが更新される
- `Log`シートに`COMMIT_SINGLES`イベントが記録される

**確認ポイント**:
- `Picks`シートを確認
- `Teams`シートを確認

---

#### テストケース 3.2.3: 手動で次へ進める
**前提条件**: 
- 手動モードがON
- 現在のサブラウンドの処理が完了

**手順**:
1. 運営センターの「抽選」タブを開く
2. 「次へ進める（サブラウンド/ラウンド）」ボタンをクリック
3. `Config`シートを確認

**期待結果**:
- 次のサブラウンドまたはラウンドに進む
- `ELIGIBLE_CAPTAINS`が正しく更新される
- フォームが回答を受け付ける状態になる
- `Log`シートに`SUBROUND_OPEN`または`ROUND_OPEN`イベントが記録される

**確認ポイント**:
- `Config`シートの値を確認
- フォームの状態を確認

---

## 4. バグ修正項目の確認テスト

### 4.1 空のplayer名の除外テスト

#### テストケース 4.1.1: 空のplayer名の提出
**前提条件**: ラウンドが開始済み

**手順**:
1. フォームでキャプテンを選択
2. 選手を選択せずに提出（または空文字列）
3. `Requests`シートを確認
4. `Log`シートを確認

**期待結果**:
- `Requests`シートに記録されない（または記録されても無視される）
- `Log`シートに`IGNORED_SUBMISSION`イベント（`empty player`）が記録される
- 自動解決が実行されない

**確認ポイント**:
- `Requests`シートを確認
- `Log`シートを確認

---

### 4.2 既に選ばれたプレイヤーの除外テスト

#### テストケース 4.2.1: 既に選ばれたプレイヤーの再指名
**前提条件**: 
- Round 1でPlayer1がCap1に選ばれている
- Round 2が開始済み

**手順**:
1. Cap2がフォームでPlayer1を指名
2. `Requests`シートを確認
3. 解決後に`Picks`シートを確認

**期待結果**:
- `Requests`シートには記録される
- 解決時にPlayer1は除外される
- `Picks`シートにPlayer1は記録されない
- `Log`シートに`IGNORED_SUBMISSION`または除外のログが記録される

**確認ポイント**:
- `Picks`シートを確認（Player1が重複していないか）
- `Log`シートを確認

---

### 4.3 重複提出の処理テスト

#### テストケース 4.3.1: 同じキャプテンの複数回提出
**前提条件**: ラウンドが開始済み

**手順**:
1. Cap1がフォームでPlayer1を指名（時刻T1）
2. Cap1が再度フォームでPlayer2を指名（時刻T2、T2 > T1）
3. `Requests`シートを確認
4. 解決後に`Picks`シートを確認

**期待結果**:
- `Requests`シートに両方の提出が記録される
- 解決時には最新の提出（Player2）のみが使用される
- `Picks`シートにCap1 → Player2が記録される

**確認ポイント**:
- `Requests`シートのタイムスタンプを確認
- `Picks`シートを確認

---

### 4.4 枠3の式修正確認テスト

#### テストケース 4.4.1: Audienceシートの枠3表示
**前提条件**: 
- 複数の選手が選ばれている
- Audienceシートが作成済み

**手順**:
1. メニュー「ドラフト運営」→「Audienceを再構築」を実行
2. `Audience`シートの枠3列を確認
3. 各キャプテンの3番目の選手が正しく表示されるか確認

**期待結果**:
- 枠3に3番目に選ばれた選手が表示される
- 式が`INDEX(FILTER(...), 3)`になっている

**確認ポイント**:
- `Audience`シートの枠3列の式を確認
- 表示内容が正しいか確認

---

## 5. エッジケース・エラー処理テスト

### 5.1 Eligible外のキャプテンの提出テスト

#### テストケース 5.1.1: Eligible外のキャプテンが提出
**前提条件**: 
- Round 1, Sub 2が開始済み
- `ELIGIBLE_CAPTAINS`にCap1のみが設定されている

**手順**:
1. Cap2（Eligible外）がフォームでPlayer1を指名
2. `Requests`シートを確認
3. `Log`シートを確認

**期待結果**:
- `Requests`シートに記録されない（または記録されても無視される）
- `Log`シートに`IGNORED_SUBMISSION`イベント（`not eligible`）が記録される
- 自動解決が実行されない

**確認ポイント**:
- `Log`シートを確認

---

### 5.2 全選手が選ばれた場合のテスト

#### テストケース 5.2.1: 全選手が選ばれた後の処理
**前提条件**: 
- 残り選手が1人のみ
- 複数のキャプテンが残っている

**手順**:
1. 最後の選手が選ばれる
2. 次のラウンドへの進行を確認

**期待結果**:
- 次のラウンドが開始される
- `remainingPlayers()`が空の場合の処理が正しく動作する

**確認ポイント**:
- `Config`シートで`ROUND`が増えているか確認
- エラーが発生しないか確認

---

### 5.3 同時提出のロック処理テスト

#### テストケース 5.3.1: 同時提出の処理
**前提条件**: ラウンドが開始済み

**手順**:
1. 複数のキャプテンがほぼ同時にフォームを提出
2. `Requests`シートを確認
3. `Log`シートを確認

**期待結果**:
- 全ての提出が正しく記録される
- ロックが機能して重複処理が発生しない
- エラーが発生しない

**確認ポイント**:
- `Requests`シートの全レコードを確認
- `Log`シートでエラーがないか確認

---

## 6. UIテスト

### 6.1 運営センターUIテスト

#### テストケース 6.1.1: 運営タブの表示
**前提条件**: 運営センターが開いている

**手順**:
1. 運営タブをクリック
2. 各要素の表示を確認

**期待結果**:
- Round/Subが正しく表示される
- 受付状態が正しく表示される
- Eligible Captainsが表示される
- 手動モードのチェックボックスが正しい状態で表示される
- フォームリンクが正しく設定される

**確認ポイント**:
- 表示内容が正しいか確認
- ボタンが正しく動作するか確認

---

#### テストケース 6.1.2: 抽選タブの表示
**前提条件**: 
- 運営センターが開いている
- 競合または単独指名が存在

**手順**:
1. 抽選タブをクリック
2. 単独指名と競合が正しく表示されるか確認

**期待結果**:
- 単独指名が正しく表示される
- 競合が正しく表示される
- 未提出のキャプテン数が表示される
- ルーレットボタンが表示される

**確認ポイント**:
- 表示内容が正しいか確認
- ボタンがクリック可能か確認

---

### 6.2 配信画面UIテスト

#### テストケース 6.2.1: 配信画面の表示
**前提条件**: 配信画面のURLが取得できる

**手順**:
1. 配信画面を開く（`doGet()`のURL）
2. 各要素の表示を確認
3. 自動更新を確認（3秒間隔）

**期待結果**:
- Round/Subが正しく表示される
- LIVE/PAUSE状態が正しく表示される
- 単独指名が表示される
- 競合が表示される
- チームボードが表示される
- イベントログが表示される
- 3秒ごとに自動更新される

**確認ポイント**:
- 表示内容が正しいか確認
- 自動更新が動作するか確認
- レスポンシブデザインが正しいか確認

---

## 7. 統合テスト

### 7.1 完全なラウンド進行テスト

#### テストケース 7.1.1: Round 1からRound 3までの完全進行
**前提条件**: 
- キャプテン3人、選手9人以上
- 自動モード

**手順**:
1. Round 1, Sub 1を開始
2. 各キャプテンが選手を指名
3. 競合が発生するように調整
4. Round 3まで進行
5. 各段階でデータを確認

**期待結果**:
- 各ラウンドが正しく進行する
- サブラウンドが正しく進行する
- `Picks`シートが正しく記録される
- `Teams`シートが正しく更新される
- `Log`シートに全てのイベントが記録される
- 優先ポイントが正しく更新される

**確認ポイント**:
- 全シートの内容を確認
- データの整合性を確認

---

### 7.2 手動モードと自動モードの切り替えテスト

#### テストケース 7.2.1: モード切り替え
**前提条件**: フォームが作成済み

**手順**:
1. 自動モードでラウンドを開始
2. 手動モードに切り替え
3. 手動で抽選を実行
4. 自動モードに戻す
5. 次のラウンドを開始

**期待結果**:
- モード切り替えが正しく動作する
- 各モードで正しく動作する
- データの整合性が保たれる

**確認ポイント**:
- `Config`シートの`MANUAL_MODE`を確認
- 各モードでの動作を確認

---

## テストチェックリスト

### 必須確認項目
- [ ] フォームが正しく作成される
- [ ] トリガーが正しく設定される
- [ ] 自動モードで単独指名が正しく処理される
- [ ] 自動モードで競合が正しく処理される
- [ ] 優先ポイントが正しく更新される
- [ ] 手動モードで抽選が正しく動作する
- [ ] 空のplayer名が除外される
- [ ] 既に選ばれたプレイヤーが除外される
- [ ] 重複提出が最新のみ使用される
- [ ] サブラウンドが正しく進行する
- [ ] ラウンドが正しく進行する
- [ ] UIが正しく表示される
- [ ] ログが正しく記録される

### エラー処理確認項目
- [ ] Eligible外のキャプテンの提出が無視される
- [ ] 同時提出が正しく処理される
- [ ] エラー時に適切なログが記録される
- [ ] UIでエラーが適切に表示される

---

## トラブルシューティング

### よくある問題と対処法

#### 問題1: フォームが作成されない
**原因**: `Players`または`Captains`シートが空
**対処**: シートにデータを入力してから再実行

#### 問題2: 自動解決が実行されない
**原因**: 
- 手動モードがON
- Eligibleキャプテンの提出が揃っていない
**対処**: 
- 手動モードをOFFにする
- `Requests`シートで提出数を確認

#### 問題3: 競合が正しく処理されない
**原因**: 優先ポイントの計算エラー
**対処**: `Captains`シートの`Prio`列を確認

#### 問題4: UIが更新されない
**原因**: ブラウザのキャッシュ
**対処**: ブラウザをリロード（Ctrl+F5）

---

## テスト実行時の注意事項

1. **テストデータの準備**: 本番データを使用しない
2. **バックアップ**: テスト前にスプレッドシートをコピー
3. **ログ確認**: 各テスト後に`Log`シートを確認
4. **データ整合性**: 各テスト後に全シートの整合性を確認
5. **エラー記録**: エラーが発生した場合は詳細を記録

---

## テスト完了基準

以下の条件を全て満たした場合、テスト完了とみなします：

1. 全ての必須確認項目がクリアされている
2. エラー処理確認項目がクリアされている
3. 統合テストが正常に完了している
4. 既知のバグが修正されている
5. 新たな重大なバグが発見されていない

